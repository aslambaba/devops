---
- hosts: NGLoadBalancer
  become: yes
  tasks:
    - name: Install Nginx
      apt: 
        name:
          - nginx
    - name: Copy Nginx File to LB
      copy:  
        src:  /home/ubuntu/devops/Projects/02_useTerraform_nginxLoadBalancer_andSetup_docker_instance/nginx_LB.conf
        dest: /etc/nginx/
    - name: Rename File
      shell: "mv /etc/nginx/nginx_LB.conf /etc/nginx/nginx.conf"
    - name: Restart Nginx
      shell: "systemctl restart nginx"
- hosts: webServer
  become: yes
  vars:
    Repo_Name: MyShoes
    GitHub_Url: https://github.com/aslambaba/
  tasks:
    - name: Install Git and Curl
      apt:
        name:
          - git
          - curl
        state: present
    - name: Download Nodejs File And Nginx
      shell: "curl -sL https://deb.nodesource.com/setup_16.x | sudo bash - && apt -y install nodejs && npm install -g npm@8.19.1 && apt install nginx -y"
    - name: Install PM2
      shell: "npm install pm2@latest -g"
    - name: Clone MyShoes into WorkerNodes
      shell: "cd ~/ && rm -rf {{Repo_Name}} && git clone {{GitHub_Url}}{{Repo_Name}}"
    - name: Copy Clone File into Nginx Conf
      copy:
        src: ~/MyShoes/
        dest: /var/www/html/
        remote_src: yes
    - name: Install Project Dep
      shell: "cd /var/www/html && sudo npm install"
    - name: Copy NginxConf File
      copy:
        src: /home/ubuntu/devops/Projects/02_useTerraform_nginxLoadBalancer_andSetup_docker_instance/nginx.conf
        dest: /etc/nginx/
    - name: Restart Nginx
      shell: "systemctl restart nginx"
    - name: RUN APPLICATION
      shell: "cd /var/www/html && pm2 start --name {{Repo_Name}} npm -- start"
- hosts: dockerServer
  become: yes
  vars:
    Repo_Name: Camille-project
    GitHub_Url: https://github.com/aslambaba/
  tasks:
    - name: Install Docker
      shell: "apt install docker.io -y"
    - name: Remove Old Repo
      shell: "cd /home/ubuntu/ && rm -rf {{Repo_Name}}"
    - name: Stop & Remove Old Container
      shell: "docker stop $(docker ps -a -q)"
    - name: Clone new Image
      shell: git clone {{GitHub_Url}}{{Repo_Name}}
    - name: Build DockerImage
      shell: "docker build -t aslambaba/camile /home/ubuntu/{{Repo_Name}}/."
    - name: Run Container
      shell: "sudo docker run --name aslam_camile_proj -it -p 80:80 aslambaba/camile && sudo docker exec aslam_camile_proj /etc/init.d/nginx restart "